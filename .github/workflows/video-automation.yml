name: ğŸ¬ CrÃ©ation VidÃ©o Automatique (Version Universelle)

on:
  schedule:
    # Tous les jours Ã  10h00 UTC
    - cron: '0 10 * * *'
  workflow_dispatch:  # Permet lancement manuel

jobs:
  create-and-publish-video:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests
          pip install moviepy
          pip install google-auth google-auth-oauthlib google-auth-httplib2
          pip install google-api-python-client
          sudo apt-get update
          sudo apt-get install -y imagemagick
      
      - name: ğŸ¤– Generate Video Script with HuggingFace (FREE - Disponible partout!)
        id: generate_script
        env:
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          python << 'EOF'
          import requests
          import json
          import random
          import os
          
          # Liste de sujets prÃ©dÃ©finis (si l'API Ã©choue)
          fallback_topics = [
              {
                  "titre": "Le paradoxe de Fermi expliquÃ© simplement",
                  "script": "Pourquoi n'avons-nous jamais rencontrÃ© d'extraterrestres ? C'est le paradoxe de Fermi. Avec des milliards de galaxies, la vie devrait Ãªtre partout. Pourtant, silence radio complet. Trois thÃ©ories : soit nous sommes seuls, soit les civilisations s'autodÃ©truisent, soit elles nous Ã©vitent volontairement. La vÃ©ritÃ© reste un mystÃ¨re fascinant.",
                  "description": "DÃ©couvrez le paradoxe de Fermi et pourquoi nous n'avons jamais rencontrÃ© d'extraterrestres malgrÃ© les milliards de galaxies.",
                  "tags": "science, espace, astronomie, fermi, extraterrestres",
                  "hashtags": "#Science #Espace #Astronomie #Paradoxe"
              },
              {
                  "titre": "Comment fonctionne vraiment ChatGPT ?",
                  "script": "ChatGPT n'est pas magique, c'est des mathÃ©matiques gÃ©antes ! Il prÃ©dit le mot suivant dans une phrase, encore et encore. EntraÃ®nÃ© sur des milliards de textes, il a appris les patterns du langage humain. C'est comme un autocomplete surpuissant qui comprend le contexte. Fascinant et un peu effrayant Ã  la fois !",
                  "description": "Comprendre comment ChatGPT fonctionne rÃ©ellement : de simples prÃ©dictions de mots transformÃ©es en IA conversationnelle.",
                  "tags": "IA, ChatGPT, technologie, intelligence artificielle, machine learning",
                  "hashtags": "#IA #ChatGPT #Tech #AI"
              },
              {
                  "titre": "Le secret des centenaires d'Okinawa",
                  "script": "Ã€ Okinawa au Japon, les gens vivent rÃ©guliÃ¨rement plus de 100 ans. Leur secret ? Le concept 'Hara Hachi Bu' : manger jusqu'Ã  80% de satiÃ©tÃ©. Ils consument aussi beaucoup de patates douces, marchent quotidiennement et gardent un but de vie fort appelÃ© 'Ikigai'. Simple mais efficace : modÃ©ration et purpose.",
                  "description": "DÃ©couvrez les secrets de longÃ©vitÃ© des centenaires d'Okinawa : alimentation, mouvement et philosophie de vie.",
                  "tags": "santÃ©, longÃ©vitÃ©, Okinawa, bien-Ãªtre, nutrition",
                  "hashtags": "#SantÃ© #LongÃ©vitÃ© #BienÃŠtre #Japon"
              },
              {
                  "titre": "Pourquoi on oublie ses rÃªves au rÃ©veil ?",
                  "script": "Vous faites des rÃªves incroyables mais 90% disparaissent en quelques minutes ? C'est normal ! Pendant le sommeil, le cerveau dÃ©sactive une partie de la mÃ©moire pour se concentrer sur le repos. Au rÃ©veil, la chimie cÃ©rÃ©brale change brutalement et les souvenirs de rÃªves s'Ã©vaporent. Astuce : notez-les immÃ©diatement !",
                  "description": "Explication scientifique de pourquoi nous oublions nos rÃªves et comment mieux s'en souvenir.",
                  "tags": "science, sommeil, rÃªves, cerveau, neuroscience",
                  "hashtags": "#Science #Sommeil #RÃªves #Cerveau"
              },
              {
                  "titre": "La rÃ¨gle des 2 minutes qui change tout",
                  "script": "Voici la rÃ¨gle qui booste la productivitÃ© : si une tÃ¢che prend moins de 2 minutes, fais-la immÃ©diatement. RÃ©pondre Ã  un email, ranger un objet, noter une idÃ©e. Ces micro-tÃ¢ches s'accumulent et crÃ©ent de la procrastination. En les faisant sur-le-champ, votre charge mentale diminue drastiquement. Simple mais puissant !",
                  "description": "La rÃ¨gle des 2 minutes pour augmenter votre productivitÃ© et rÃ©duire la procrastination au quotidien.",
                  "tags": "productivitÃ©, organisation, dÃ©veloppement personnel, efficacitÃ©",
                  "hashtags": "#ProductivitÃ© #DevPerso #Motivation #Organisation"
              }
          ]
          
          # Choisir un sujet alÃ©atoire
          data = random.choice(fallback_topics)
          
          # Optionnel : Essayer l'API HuggingFace (gratuit)
          try:
              if 'HUGGINGFACE_TOKEN' in os.environ:
                  headers = {"Authorization": f"Bearer {os.environ['HUGGINGFACE_TOKEN']}"}
                  API_URL = "https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2"
                  
                  prompt = """GÃ©nÃ¨re un script de vidÃ©o Ã©ducative virale de 35 secondes.
                  Format JSON uniquement :
                  {"titre": "...", "script": "...", "description": "...", "tags": "...", "hashtags": "..."}"""
                  
                  response = requests.post(
                      API_URL, 
                      headers=headers, 
                      json={"inputs": prompt},
                      timeout=30
                  )
                  
                  if response.status_code == 200:
                      result = response.json()[0]['generated_text']
                      # Essayer de parser le JSON
                      import re
                      json_match = re.search(r'\{.*\}', result, re.DOTALL)
                      if json_match:
                          data = json.loads(json_match.group())
          except Exception as e:
              print(f"â„¹ï¸ Utilisation d'un sujet prÃ©dÃ©fini (API non disponible: {e})")
          
          # Sauvegarder
          with open('script.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          
          print(f"âœ… Script sÃ©lectionnÃ©: {data['titre']}")
          print(f"Script: {data['script'][:100]}...")
          EOF
      
      - name: ğŸ¬ Create Video with MoviePy (FREE)
        run: |
          python << 'EOF'
          from moviepy.editor import *
          import json
          import textwrap
          
          # Charger le script
          with open('script.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          # ParamÃ¨tres
          WIDTH, HEIGHT = 1920, 1080
          DURATION = 35
          
          # Fond dÃ©gradÃ© (plus joli qu'un fond noir)
          from moviepy.video.fx.all import colorx
          background = ColorClip(size=(WIDTH, HEIGHT), color=(20, 20, 40), duration=DURATION)
          
          # Titre en haut (5 premiÃ¨res secondes)
          title_clip = TextClip(
              data['titre'],
              fontsize=80,
              color='#FFD700',  # Or
              font='Arial-Bold',
              size=(WIDTH - 200, None),
              method='caption',
              align='center',
              stroke_color='black',
              stroke_width=3
          ).set_position(('center', 150)).set_duration(5).fadeout(0.5)
          
          # Script principal (texte dÃ©filant)
          script_text = data['script']
          
          # DÃ©couper le texte en lignes
          lines = textwrap.wrap(script_text, width=50)
          
          # CrÃ©er plusieurs clips de texte qui apparaissent progressivement
          text_clips = []
          words = script_text.split()
          words_per_second = len(words) / DURATION
          
          script_clip = TextClip(
              script_text,
              fontsize=55,
              color='white',
              font='Arial',
              size=(WIDTH - 300, HEIGHT - 400),
              method='caption',
              align='center',
              stroke_color='black',
              stroke_width=2
          ).set_position('center').set_duration(DURATION).fadein(0.5)
          
          # Hashtags en bas (derniÃ¨res 5 secondes)
          hashtag_clip = TextClip(
              data['hashtags'],
              fontsize=45,
              color='#00D9FF',  # Bleu clair
              font='Arial-Bold',
              size=(WIDTH - 200, None),
              method='caption',
              align='center'
          ).set_position(('center', HEIGHT - 150)).set_start(30).set_duration(5).fadein(0.3)
          
          # Composer la vidÃ©o
          video = CompositeVideoClip([
              background,
              title_clip,
              script_clip,
              hashtag_clip
          ])
          
          # Exporter
          video.write_videofile(
              'video_output.mp4',
              fps=24,
              codec='libx264',
              audio=False,
              preset='ultrafast',
              threads=4
          )
          
          print("âœ… VidÃ©o crÃ©Ã©e avec succÃ¨s!")
          EOF
      
      - name: â˜ï¸ Upload to Google Drive (FREE)
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: |
          python << 'EOF'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          import json
          import os
          from datetime import datetime
          
          # Credentials
          credentials_info = json.loads(os.environ['GDRIVE_CREDENTIALS'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_info,
              scopes=['https://www.googleapis.com/auth/drive.file']
          )
          
          service = build('drive', 'v3', credentials=credentials)
          
          # Upload
          timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
          
          with open('script.json', 'r', encoding='utf-8') as f:
              script_data = json.load(f)
          
          file_metadata = {
              'name': f"{script_data['titre'][:30]}_{timestamp}.mp4",
              'mimeType': 'video/mp4'
          }
          
          media = MediaFileUpload('video_output.mp4', mimetype='video/mp4', resumable=True)
          
          file = service.files().create(
              body=file_metadata,
              media_body=media,
              fields='id,webViewLink'
          ).execute()
          
          print(f"âœ… VidÃ©o uploadÃ©e sur Google Drive!")
          print(f"Link: {file.get('webViewLink')}")
          EOF
      
      - name: ğŸ“º Upload to YouTube (FREE)
        env:
          YOUTUBE_CREDENTIALS: ${{ secrets.YOUTUBE_CREDENTIALS }}
        run: |
          python << 'EOF'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          import json
          import os
          from datetime import datetime
          
          # Charger script
          with open('script.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          # Credentials
          credentials_info = json.loads(os.environ['YOUTUBE_CREDENTIALS'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_info,
              scopes=['https://www.googleapis.com/auth/youtube.upload']
          )
          
          youtube = build('youtube', 'v3', credentials=credentials)
          
          # MÃ©tadonnÃ©es
          body = {
              'snippet': {
                  'title': data['titre'],
                  'description': f"{data['description']}\n\n{data['hashtags']}\n\nğŸ¤– VidÃ©o gÃ©nÃ©rÃ©e automatiquement\nğŸ“… {datetime.now().strftime('%d/%m/%Y')}",
                  'tags': data['tags'].split(', '),
                  'categoryId': '27'  # Education
              },
              'status': {
                  'privacyStatus': 'public',
                  'selfDeclaredMadeForKids': False
              }
          }
          
          # Upload
          media = MediaFileUpload('video_output.mp4', chunksize=-1, resumable=True)
          
          request = youtube.videos().insert(
              part='snippet,status',
              body=body,
              media_body=media
          )
          
          response = request.execute()
          video_id = response['id']
          video_url = f"https://www.youtube.com/watch?v={video_id}"
          
          print(f"âœ… VidÃ©o publiÃ©e sur YouTube!")
          print(f"URL: {video_url}")
          
          # Sauvegarder l'URL pour le summary
          with open('youtube_url.txt', 'w') as f:
              f.write(video_url)
          EOF
      
      - name: ğŸ“Š RÃ©sumÃ© de l'exÃ©cution
        if: success()
        run: |
          echo "# âœ… VIDÃ‰O PUBLIÃ‰E AVEC SUCCÃˆS! ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“º YouTube" >> $GITHUB_STEP_SUMMARY
          if [ -f youtube_url.txt ]; then
            echo "URL: $(cat youtube_url.txt)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ Script gÃ©nÃ©rÃ©" >> $GITHUB_STEP_SUMMARY
          cat script.json >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ• Informations" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Prochaine exÃ©cution: Demain Ã  10h UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¤– Automatisation by GitHub Actions" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Notification d'Ã©chec
        if: failure()
        run: |
          echo "# âŒ ERREUR lors de la crÃ©ation/publication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Consultez les logs ci-dessus pour identifier le problÃ¨me." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ProblÃ¨mes courants:" >> $GITHUB_STEP_SUMMARY
          echo "- VÃ©rifiez que tous les secrets sont bien configurÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "- VÃ©rifiez les permissions du Service Account Google" >> $GITHUB_STEP_SUMMARY
          echo "- VÃ©rifiez les quotas API YouTube" >> $GITHUB_STEP_SUMMARY
