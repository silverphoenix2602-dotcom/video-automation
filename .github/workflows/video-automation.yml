name: ğŸ¬ CrÃ©ation VidÃ©o Automatique

on:
  schedule:
    # Tous les jours Ã  10h00 UTC
    - cron: '0 10 * * *'
  workflow_dispatch:  # Permet lancement manuel

jobs:
  create-and-publish-video:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install google-generativeai
          pip install moviepy
          pip install requests
          pip install google-auth google-auth-oauthlib google-auth-httplib2
          pip install google-api-python-client
      
      - name: ğŸ¤– Generate Video Script with Gemini (FREE)
        id: generate_script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import google.generativeai as genai
          import json
          import os
          
          # Configuration Gemini (GRATUIT)
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-pro')
          
          # GÃ©nÃ©rer le script
          prompt = """
          GÃ©nÃ¨re un script de vidÃ©o Ã©ducative virale de 35 secondes.
          Sujet : Technologie fascinante ou fait scientifique incroyable
          
          Retourne UNIQUEMENT un JSON valide :
          {
            "titre": "Titre accrocheur max 60 caractÃ¨res",
            "script": "Le script complet Ã  lire (35 secondes)",
            "description": "Description YouTube avec mots-clÃ©s SEO",
            "tags": "tag1, tag2, tag3, tag4, tag5",
            "hashtags": "#tech #science #education"
          }
          """
          
          response = model.generate_content(prompt)
          script_data = response.text
          
          # Nettoyer et parser le JSON
          script_data = script_data.replace('```json', '').replace('```', '').strip()
          data = json.loads(script_data)
          
          # Sauvegarder dans un fichier
          with open('script.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          
          # Outputs pour GitHub Actions
          print(f"::set-output name=titre::{data['titre']}")
          print(f"::set-output name=script::{data['script']}")
          
          print("âœ… Script gÃ©nÃ©rÃ© avec succÃ¨s!")
          EOF
      
      - name: ğŸ¬ Create Video with MoviePy (FREE)
        run: |
          python << 'EOF'
          from moviepy.editor import *
          import json
          
          # Charger le script
          with open('script.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          script_text = data['script']
          
          # CrÃ©er une vidÃ©o simple avec texte
          # Fond noir
          background = ColorClip(size=(1920, 1080), color=(0, 0, 0), duration=35)
          
          # Texte principal
          txt_clip = TextClip(
              script_text,
              fontsize=50,
              color='white',
              font='Arial-Bold',
              size=(1600, None),
              method='caption',
              align='center'
          ).set_position('center').set_duration(35)
          
          # Titre en haut
          title_clip = TextClip(
              data['titre'],
              fontsize=70,
              color='yellow',
              font='Arial-Bold',
              size=(1600, None),
              method='caption',
              align='center'
          ).set_position(('center', 100)).set_duration(5)
          
          # Composer la vidÃ©o
          video = CompositeVideoClip([background, txt_clip, title_clip])
          
          # Exporter
          video.write_videofile(
              'video_output.mp4',
              fps=24,
              codec='libx264',
              audio=False
          )
          
          print("âœ… VidÃ©o crÃ©Ã©e avec succÃ¨s!")
          EOF
      
      - name: â˜ï¸ Upload to Google Drive (FREE)
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: |
          python << 'EOF'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          import json
          import os
          from datetime import datetime
          
          # Credentials Google Drive
          credentials_info = json.loads(os.environ['GDRIVE_CREDENTIALS'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_info,
              scopes=['https://www.googleapis.com/auth/drive.file']
          )
          
          # Service Drive
          service = build('drive', 'v3', credentials=credentials)
          
          # Upload
          timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
          file_metadata = {
              'name': f'video_auto_{timestamp}.mp4',
              'mimeType': 'video/mp4'
          }
          
          media = MediaFileUpload('video_output.mp4', mimetype='video/mp4', resumable=True)
          
          file = service.files().create(
              body=file_metadata,
              media_body=media,
              fields='id,webViewLink'
          ).execute()
          
          print(f"âœ… VidÃ©o uploadÃ©e sur Google Drive: {file.get('webViewLink')}")
          print(f"::set-output name=drive_link::{file.get('webViewLink')}")
          EOF
      
      - name: ğŸ“º Upload to YouTube (FREE)
        env:
          YOUTUBE_CREDENTIALS: ${{ secrets.YOUTUBE_CREDENTIALS }}
        run: |
          python << 'EOF'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          import json
          import os
          
          # Charger le script pour mÃ©tadonnÃ©es
          with open('script.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          # Credentials YouTube
          credentials_info = json.loads(os.environ['YOUTUBE_CREDENTIALS'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_info,
              scopes=['https://www.googleapis.com/auth/youtube.upload']
          )
          
          # Service YouTube
          youtube = build('youtube', 'v3', credentials=credentials)
          
          # MÃ©tadonnÃ©es vidÃ©o
          body = {
              'snippet': {
                  'title': data['titre'],
                  'description': f"{data['description']}\n\n{data['hashtags']}\n\nğŸ¤– VidÃ©o gÃ©nÃ©rÃ©e automatiquement par IA",
                  'tags': data['tags'].split(', '),
                  'categoryId': '28'  # Science & Technology
              },
              'status': {
                  'privacyStatus': 'public',  # ou 'unlisted' pour tester
                  'selfDeclaredMadeForKids': False
              }
          }
          
          # Upload
          media = MediaFileUpload('video_output.mp4', chunksize=-1, resumable=True)
          
          request = youtube.videos().insert(
              part='snippet,status',
              body=body,
              media_body=media
          )
          
          response = request.execute()
          
          video_id = response['id']
          video_url = f"https://www.youtube.com/watch?v={video_id}"
          
          print(f"âœ… VidÃ©o publiÃ©e sur YouTube: {video_url}")
          print(f"::set-output name=youtube_url::{video_url}")
          EOF
      
      - name: ğŸ“§ Send Notification Email (FREE via GitHub)
        if: success()
        run: |
          echo "âœ… VIDÃ‰O PUBLIÃ‰E AVEC SUCCÃˆS!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“º YouTube: VÃ©rifiez votre chaÃ®ne" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¾ Google Drive: VidÃ©o sauvegardÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ• Date: $(date)" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Notification d'Ã©chec
        if: failure()
        run: |
          echo "âŒ ERREUR lors de la crÃ©ation/publication" >> $GITHUB_STEP_SUMMARY
          echo "VÃ©rifiez les logs ci-dessus" >> $GITHUB_STEP_SUMMARY
